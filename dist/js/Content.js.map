{"version":3,"file":"Content.js","sources":["../../src/contentScript/Popup.svelte","../../src/contentScript/ToolBar.svelte","../../src/contentScript/Content.svelte"],"sourcesContent":["<!-- TODO:\r\n    when canSubmit is off, make it visible & disable submit button\r\n    see if I can do something about the z-index\r\n    add a little movement animation ;) (or maybe not because sounds like bad UX)\r\n-->\r\n<script>\r\n    import { onMount } from \"svelte/internal\";\r\n    import {addNote, AnkiConnectionError, AnkiResponseError, getDeckNames, getModelFieldNames, getModelNames} from '../ankiConnectUtil'\r\n    import { EXTENSION_ALIAS, REPLACEMENT_STRING } from \"../const\";\r\n    import { horizontalSlideDisconsiderBorder } from \"../svelteTransition\";\r\n    import { compareArrays, escapeHtml } from \"../util\";\r\n\r\n    export let staticHoverNode\r\n    export let parentDocument = document\r\n    export let options\r\n    export let contentToSave = undefined\r\n    export let initialX = 0\r\n    export let initialY = 0\r\n    console.log('initialY', initialY)\r\n    let popupNode\r\n    let isPopupBeingDragged = false\r\n    let isPopupEnabled = false\r\n\r\n    let cardModelSelectNode\r\n    let selectedDeck\r\n    let deckNameSelectNode\r\n    let selectedModel\r\n    \r\n    let savedSyncFields\r\n    \r\n    let cardDecks = []\r\n    let cardModels = []\r\n    let cardModelFieldsData = {}\r\n    let messageType = ''\r\n    let canSubmit = false\r\n    let highlightWarnClose = false\r\n    let highlightSubmitSuccessful = false\r\n\r\n    const TRANSITION_DURATION_MS = 300\r\n    \r\n\r\n    onMount(() => {\r\n        popupNode.style.left = initialX + 'px'\r\n        popupNode.style.top = initialY + 'px'\r\n        isPopupEnabled = true\r\n        tryAnkiConnectionLoop()\r\n        parentDocument.addEventListener('mouseup', handleDocumentMouseUp)\r\n    })\r\n\r\n    async function tryAnkiConnectionLoop(isFirstTime = true) {\r\n        try {\r\n            const newCardDecks = await getDeckNames()\r\n            const newCardModels = await getModelNames()\r\n            if (!(newCardDecks && newCardModels)) {\r\n                throw new AnkiResponseError()\r\n            } else {\r\n                cardDecks = newCardDecks\r\n                cardModels = newCardModels\r\n\r\n                canSubmit = true\r\n\r\n                if (cardModels.length > 1) {\r\n                    updateModelFields(cardModels[0])\r\n                }\r\n\r\n                if (!isFirstTime) {\r\n                    messageType = 'success'\r\n                  setTimeout(() => {messageType = ''}, 5000)\r\n                } else {\r\n                    messageType = ''\r\n                }\r\n\r\n                // load synced options\r\n                selectedDeck = (await chrome.storage.sync.get('selectedDeck')).selectedDeck\r\n                selectedModel = (await chrome.storage.sync.get('selectedModel')).selectedModel\r\n                // load synced fields\r\n                savedSyncFields = (await chrome.storage.sync.get('savedFields')).savedFields || {}\r\n\r\n          }\r\n        } catch (err) {\r\n            handleAnkiError(err, () => tryAnkiConnectionLoop(false))\r\n            \r\n        }\r\n    }\r\n\r\n    let secsUntilRetry = 0\r\n    function handleAnkiError(error, callback) {\r\n        console.error(error)\r\n        switch (error.constructor) {\r\n            case AnkiConnectionError:\r\n            messageType = 'connection'\r\n            break\r\n        case AnkiResponseError:\r\n            messageType = 'response'\r\n            break\r\n        default:\r\n            messageType = 'unknown'\r\n            break\r\n        }\r\n\r\n        if (callback) {\r\n            secsUntilRetry = 5\r\n            let countdown = setInterval(() => {\r\n                secsUntilRetry-= 1\r\n                if (secsUntilRetry == 0) {\r\n                    callback()\r\n                    clearInterval(countdown)\r\n                }\r\n            }, 1000)\r\n        }\r\n\r\n    }\r\n\r\n    async function handleSubmit(e) {\r\n        const formData = new FormData(e.target)\r\n        const fieldsData = Object.keys(cardModelFieldsData).reduce((obj, fieldName) => (\r\n            obj[fieldName]= cardModelFieldsData[fieldName].value,\r\n            obj\r\n            ), {})\r\n        const fieldsDataReplaced = Object.keys(fieldsData).reduce((obj, fieldName) => (\r\n            obj[fieldName]=fieldsData[fieldName].replaceAll('$replace$', contentToSave),\r\n            obj\r\n            ), {})\r\n\r\n        canSubmit = false\r\n        let callbackResult\r\n        try {\r\n            callbackResult = await addNote(formData.get('deckName'), formData.get('modelName'), fieldsDataReplaced)\r\n        } catch (err) {\r\n            messageType = 'response'\r\n            setTimeout(() => {\r\n                messageType = ''\r\n            }, 5000)\r\n        }    \r\n        if (callbackResult) {\r\n            highlightSubmitSuccessful = true\r\n            setTimeout(() => {\r\n                highlightSubmitSuccessful = false\r\n            }, 5000)\r\n            // sync selections\r\n            syncDeckAndModelChoices(formData.get('deckName'), formData.get('modelName'))\r\n            syncFields(fieldsData)\r\n        } else {\r\n            handleAnkiError(new AnkiResponseError())\r\n        }\r\n        canSubmit = true\r\n    }\r\n\r\n    function syncDeckAndModelChoices(deckName, modelName) {\r\n        chrome.storage.sync.set({selectedDeck: deckName, selectedModel: modelName})\r\n    }\r\n\r\n    function syncFields(fieldsData) {\r\n        /* \r\n        I suppose there's no documentation, but for Array.reduce(), if you return 2 items then 1st value should be the \"accumulation function\",\r\n        and the 2nd should be the accumulation itself. so for an object, an assignment and the object itself.\r\n        if you only return 1 object, it should be the accumulation. quirky, huh?\r\n        */\r\n        // I wanted to make this save for every field BUT it could eat up the storage for storage.sync so...   \r\n        Object.keys(fieldsData).reduce((obj, fieldName) => {\r\n            if (fieldsData[fieldName].shouldSave) {\r\n                return (obj[fieldName],obj)\r\n            } else {\r\n                return obj\r\n            }\r\n        }, {})\r\n        console.log('saving fields:', fieldsData)\r\n        chrome.storage.sync.set({savedFields: fieldsData})\r\n    }\r\n\r\n    let initialDragOffsetX, \r\n        initialDragOffsetY\r\n    function handleDragMouseDown(e) {\r\n        const popupRect = popupNode.getBoundingClientRect()\r\n        // offset should be negative because the popup's top-left is always a negative amount offset\r\n        // from the cursor. this is just calculating that offset based on where the cursor is on the popup\r\n        initialDragOffsetX = - e.clientX + popupRect.left\r\n        initialDragOffsetY = - e.clientY + popupRect.top \r\n        parentDocument.addEventListener('mousemove', handleDragMouseMove)\r\n        parentDocument.addEventListener('mouseup', handleDragMouseUp)\r\n        isPopupBeingDragged = true\r\n        highlightWarnClose = false\r\n        highlightSubmitSuccessful = false\r\n    }\r\n    \r\n    function handleDragMouseUp(e) {\r\n        isPopupBeingDragged = false\r\n\r\n        parentDocument.removeEventListener('mousemove', handleDragMouseMove)\r\n        parentDocument.removeEventListener('mouseup', handleDragMouseUp)\r\n    }\r\n        \r\n    function handleDragMouseMove(e) {\r\n        e.preventDefault()\r\n        // TODO: drag could have an animation\r\n        popupNode.style.left = (options.shouldPopupBePinned.value ? e.clientX : e.pageX) + initialDragOffsetX + 'px'\r\n        popupNode.style.top = (options.shouldPopupBePinned.value ? e.clientY : e.pageY) + initialDragOffsetY + 'px'\r\n    }\r\n\r\n    function handleDocumentMouseUp(e) {\r\n        if (e.target.id != EXTENSION_ALIAS+'-root') {\r\n            if (highlightWarnClose) {\r\n                removePopup()\r\n            } else {\r\n                highlightWarnClose = true\r\n            }\r\n        } else {\r\n            highlightWarnClose = false\r\n        }\r\n    }\r\n\r\n    function removePopup() {\r\n        isPopupEnabled = false\r\n        parentDocument.removeEventListener('mouseup', handleDocumentMouseUp)\r\n        setTimeout(() => {\r\n            popupNode.parentNode.removeChild(popupNode)\r\n        }, TRANSITION_DURATION_MS)\r\n    }\r\n\r\n    async function handleDeckSelectionChange(e) {\r\n        selectedDeck = e.target.value\r\n    }\r\n\r\n    async function handleModelSelectChange(e) {\r\n        selectedModel = e.target.value\r\n        updateModelFields(e.target.value)\r\n    }\r\n\r\n\r\n    async function updateModelFields(modelName) {\r\n        const fields = await getModelFieldNames(modelName)\r\n\r\n        // check if field structure is similar, then replace content w/ synced fields\r\n        if (compareArrays(Object.keys(savedSyncFields).sort(), fields.slice().sort())) {         \r\n            cardModelFieldsData = fields.reduce((obj, field) => {\r\n                const savedFieldContent = savedSyncFields[field]\r\n                return (obj[field]={\r\n                    value: savedFieldContent || '', \r\n                    shouldSave: savedFieldContent ? true : false,\r\n                    displayHTML: replaceWithCoolSpan(savedFieldContent)\r\n                },obj)\r\n            }, {})\r\n        } else {\r\n            cardModelFieldsData = fields.reduce((obj, field) => (obj[field]={value:'', shouldSave: false, displayHTML:''},obj), {})\r\n        }\r\n        // THIS IS A TEMPORARY REPLACEMENT UNTIL ABOVE IS IMPLEMENTED\r\n        // cardModelFieldsData = fields.reduce((obj, fieldName) => (obj[fieldName]={value: '', shouldSave: false},obj), {})\r\n\r\n    }\r\n\r\n    function replaceWithCoolSpan(content) {\r\n        const escapedContent = escapeHtml(content)\r\n        const idxOfReplaceable = content.indexOf(REPLACEMENT_STRING)\r\n        let newContent\r\n        if (idxOfReplaceable != -1) {\r\n            newContent = escapedContent.replaceAll('$replace$', '<span class=\"replaceable\">$replace$</span>') \r\n        }\r\n        return newContent\r\n    }\r\n    \r\n    function handleFieldInput(e) {\r\n        const fieldName = e.target.dataset.fieldname\r\n        const content = e.target.innerText\r\n        const escapedContent = escapeHtml(content)\r\n        const idxOfReplaceable = content.indexOf(REPLACEMENT_STRING)\r\n        let newContent\r\n        if (idxOfReplaceable != -1) {\r\n            newContent = escapedContent.replaceAll('$replace$', '<span class=\"replaceable\">$replace$</span>') \r\n        \r\n            cardModelFieldsData[fieldName].shouldSave = true\r\n        } else {\r\n            newContent = escapedContent\r\n            cardModelFieldsData[fieldName].shouldSave = false\r\n        }\r\n        cardModelFieldsData[fieldName].displayHTML = newContent\r\n    }\r\n</script>\r\n\r\n<!-- we could use Svelte's component initialization `intro`, but I also want an exit transition so.. -->\r\n<dialog open bind:this={popupNode} class=\"{options.shouldPopupBePinned.value ? 'fixed' : 'absolute'} p-0 m-0 bg-transparent popup\"\r\nstyle=\"--UIScale: {options.UIScale.value}\"\r\n>\r\n    {#if isPopupEnabled}\r\n    <div class=\"bg-zinc-800-trs w-[20rem] max-w-[20rem] rounded-[0.3rem] blur-bg relative border\r\n    {isPopupBeingDragged  ? 'shadow-xl' : highlightWarnClose || highlightSubmitSuccessful ? 'shadow-sm' : 'shadow-none'} {highlightWarnClose ? 'shadow-red-400 border-red-400' : highlightSubmitSuccessful ? 'shadow-green-400 border-green-400' : 'border-transparent shadow-black/10'}\r\n    duration-100\"\r\n    style=\"transition-property: box-shadow, border-color;\"\r\n    transition:horizontalSlideDisconsiderBorder={{axis: 'y', duration: TRANSITION_DURATION_MS}}\r\n    >\r\n        <div draggable class=\"w-full h-min py-1.5 rounded-[0.3rem] box-border flex cursor-move\r\n        hover:bg-zinc-500-trs transition-colors duration-100\r\n        \" on:mousedown={handleDragMouseDown} on:mouseup={handleDragMouseUp}>\r\n            <div class=\"grid grid-rows-2 grid-cols-4 mx-auto w-max justify-center gap-x-1 gap-y-1 my-auto\">\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n                <div class=\"bg-zinc-500 rounded-full aspect-square w-[0.16rem] h-[0.16rem]\"></div>\r\n            </div>\r\n        </div>\r\n        <div class=\"p-5 flex flex-col max-h-xs overflow-auto bg-transparent\">\r\n            <h1 class=\"text-blue-gradient font-bold text-xl mx-auto mb-5\">\r\n                Add2Anki\r\n            </h1>\r\n            {#if messageType}\r\n            <div class=\"rounded-[0.3rem] border {messageType == 'success' ? 'border-green-400' : 'border-red-400'} text-zinc-300 px-2 py-1 mb-3 flex flex-col h-max text-xs hyphens-auto\" style=\"transition: border-color 500ms, height 500ms;\"\r\n                transition:horizontalSlideDisconsiderBorder={{axis: 'y', duration: 500}}\r\n            >\r\n                <div>\r\n                {#if messageType == 'connection'}\r\n                    There has been a connection error. Make sure that Anki is open, and that <a class=\"text-blue-400 underline\" href=\"https://ankiweb.net/shared/info/2055492159\" target=\"_blank\">AnkiConnect</a> is installed & running.\r\n                {:else if messageType == 'response'}\r\n                    There has been a response error. AnkiConnect is running but did not respond properly.\r\n                {:else if messageType == 'unknown'}\r\n                    There has been an uknown error. ¯\\_(ツ)_/¯\r\n                {:else if messageType == 'success'}\r\n                    Successfully reconnected with Anki!\r\n                {/if}\r\n                </div>\r\n                {#if messageType == 'connection'}\r\n                <div class=\"block text-[0.5rem] text-zinc-400\">retrying in {secsUntilRetry} second(s) . . .</div>\r\n                {/if}\r\n            </div>\r\n            {/if}\r\n            {#if contentToSave != undefined}\r\n            <div class=\"text-xs text-zinc-400 mb-3 mx-auto flex items-center\">\r\n                <span class=\"replaceable\">$replace$</span>\r\n                <span>&nbsp;&rarr;&nbsp;</span>\r\n                <span contenteditable class=\"break-all text-zinc-300 rounded hover:bg-zinc-500-trs border-transparent hover:border-zinc-400 outline-none focus:border-blue-400 transition-colors duration-100 border px-1\" bind:innerHTML={contentToSave} on:input={(e) => {let content = e.target.innerHTML; content = escapeHtml(content)}}></span>\r\n            </div>\r\n            {/if}\r\n            <form action=\"\" class=\"text-zinc-300 text-sm\" on:submit|preventDefault={handleSubmit} id=\"leForm\">\r\n                <div class=\"w-full grid grid-cols-2 mb-3\">\r\n                    <div class=\"pr-2\">\r\n                        <label for=\"deckName\" class=\"block mb-0.5 label-on-focus\">Card Deck</label>\r\n                        <div class=\"relative\">\r\n                            <select name=\"deckName\" id=\"deckName\" class=\"w-full rounded-[0.3rem] bg-zinc-500-trs border border-zinc-600 truncate outline-none hover:border-zinc-400 focus:border-blue-400 transition-colors duration-100\"\r\n                            on:change={handleDeckSelectionChange}\r\n                            bind:this={deckNameSelectNode}\r\n                            >\r\n                                {#each cardDecks as deckName}\r\n                                    <option value={deckName} class=\"bg-zinc-800\" selected={(deckName == selectedDeck) || null}>{deckName}</option>\r\n                                {/each}\r\n                            </select>  \r\n                            <select disabled class=\"absolute w-full h-full top-0 left-0 bg-transparent border border-transparent text-zinc-500 pointer-events-none\"></select>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"pl-2\">\r\n                        <label for=\"modelName\" class=\"block mb-0.5\">Card Model</label>  \r\n                        <div class=\"relative\">\r\n                            <select name=\"modelName\" id=\"modelName\" class=\"w-full rounded-[0.3rem] bg-zinc-500-trs border border-zinc-600 truncate outline-none hover:border-zinc-400 focus:border-blue-400 transition-colors duration-100\"\r\n                            on:change={handleModelSelectChange}\r\n                            bind:this={cardModelSelectNode}\r\n                            >\r\n                                {#each cardModels as modelName}\r\n                                    <option value={modelName} class=\"bg-zinc-800\" selected={(modelName == selectedModel) || null}>{modelName}</option>\r\n                                {/each}\r\n                            </select>\r\n                            <select disabled class=\"absolute w-full h-full top-0 left-0 bg-transparent border border-transparent text-zinc-500 pointer-events-none\"></select>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                {#each Object.entries(cardModelFieldsData) as [fieldTitle, fieldDetails]}\r\n                    <div class=\"flex align-middle mb-0.5 items-center\">\r\n                        <label for={fieldTitle} class=\"mr-2\">{fieldTitle}</label>\r\n                        <small class=\"text-[0.6rem] text-zinc-400\">{#if fieldDetails.shouldSave}This field will stay saved{/if}</small>\r\n                    </div>\r\n                    <div class=\"relative w-full rounded bg-zinc-500-trs mb-3\" data-fieldName={fieldTitle} id={fieldTitle}>\r\n                        <div contenteditable=\"true\" class=\"absolute size-inherit break-all top-0 left-0 pointer-events-none overflow-clip px-1 border border-transparent hyphens-auto\" bind:innerHTML={fieldDetails.displayHTML}></div>\r\n                        <div contenteditable=\"true\" bind:innerHTML={fieldDetails.value} on:input={handleFieldInput} data-fieldName={fieldTitle} class=\"break-all relative top-0 left-0 webkit-text-transparent px-1 border hover:border-zinc-400 border-zinc-600 rounded-[0.3rem] appearance-none outline-none focus:border-blue-400 transition-colors duration-100\"></div>\r\n                    </div>\r\n                {/each}\r\n                <div class=\"opacity-0 block mb-0.5\">&nbsp;</div>\r\n                <button type=\"submit\" class=\"w-full rounded-[0.3rem] bg-zinc-500-trs border border-zinc-600 text-sm py-1 appearance-none outline-none hover:border-blue-400 hover:text-blue-400 focus:border-blue-400 focus:text-blue-400 shadow-none focus:shadow-inner shadow-blue-400 transition-colors duration-100\">Add that thing!</button>        \r\n            </form>\r\n        </div>\r\n    </div>\r\n    {/if}\r\n</dialog>\r\n\r\n<style lang=\"postcss\">\r\n    @tailwind base;\r\n    @tailwind components;\r\n    @tailwind utilities;\r\n\r\n    .blur-bg {\r\n        -webkit-backdrop-filter: blur(3px); \r\n        backdrop-filter: blur(3px);\r\n    }\r\n\r\n    .text-blue-gradient {\r\n        /* little hack - probably from css-tricks */\r\n        background-image: linear-gradient(to bottom, #63AAE1, #466FDA);\r\n        background-size: 100%;\r\n        background-repeat: repeat;\r\n\r\n        -webkit-background-clip: text;\r\n        -webkit-text-fill-color: transparent; \r\n        -moz-background-clip: text;\r\n        -moz-text-fill-color: transparent;\r\n    }\r\n\r\n    :global(.replaceable) {\r\n        @apply text-blue-400;\r\n    }\r\n    \r\n    .size-inherit {\r\n        width: inherit;\r\n        height: inherit;\r\n    }\r\n\r\n    .webkit-text-transparent {\r\n        -webkit-text-fill-color: transparent;\r\n    }\r\n\r\n    .popup {\r\n        transform-origin: top left;\r\n        scale: var(--UIScale);\r\n    }\r\n</style>\r\n","<script>\r\n    import Popup from \"./Popup.svelte\";\r\n\r\n\r\n    export let staticHoverNode\r\n    export let parentDocument\r\n    export let selectionText\r\n    export let hideToolbar\r\n    export let options\r\n    let toolbarNode\r\n    let popup\r\n\r\n    function spawnPopup() {\r\n        const toolbarRect = toolbarNode.getBoundingClientRect() \r\n        popup = new Popup({\r\n            target: staticHoverNode,\r\n            props: {\r\n                parentDocument,\r\n                staticHoverNode,\r\n                initialX: toolbarRect.left + (options.shouldPopupBePinned.value ? 0 : document.documentElement.scrollLeft || document.body.scrollLeft),\r\n                initialY: toolbarRect.top + (options.shouldPopupBePinned.value ? 0 : document.documentElement.scrollTop || document.body.scrollTop),\r\n                contentToSave: selectionText,\r\n                options\r\n            },\r\n            // intro: true,\r\n        })\r\n    }\r\n\r\n    function handleClickAnki() {\r\n        spawnPopup()\r\n        hideToolbar()\r\n    }\r\n</script>\r\n\r\n<div class=\"panel\" on:click={handleClickAnki} bind:this={toolbarNode}>\r\n    <img src={chrome.runtime.getURL(`icons/anki.png`)} alt=\"Save 2 Anki\" class=\"icon\">\r\n</div>\r\n<style>\r\n.icon {\r\n    height: 18px;\r\n    /* https://stackoverflow.com/a/37596806 */\r\n    display: block;\r\n}\r\n\r\n.panel {\r\n    z-index: 999;\r\n    cursor: pointer;\r\n    height: min-content;\r\n    width: min-content;\r\n    background-color: hsla(306, 92%, 54%, .8);\r\n    vertical-align: bottom;    \r\n    -webkit-backdrop-filter: blur(3px); \r\n    backdrop-filter: blur(3px);\r\n}\r\n</style>","<script>\r\n    import { getContext, onMount, setContext } from 'svelte'\r\n    import * as Util from \"../util\"\r\n    import ToolBar from './ToolBar.svelte'\r\n    import { DEFAULT_OPTIONS, EXTENSION_ALIAS } from '../const'\r\n    import Popup from './Popup.svelte'\r\n    \r\n    export let rootNode\r\n    export let shadowRootNode\r\n    export let parentDocument = document\r\n    \r\n    let isExtensionOn = false\r\n    let pageWidth\r\n    let hoverNode, hoverContentNode\r\n    \r\n    let isHoverOn = false\r\n    let hoverX = 0,\r\n        hoverY = 0,\r\n        cursorX = 0,\r\n        cursorY = 0,\r\n        hoverWidth = 0,\r\n        hoverHeight = 0\r\n    let hasSelection = false\r\n    let isMakingSelection = false\r\n    let previousWord\r\n    let staticHoverNode\r\n    \r\n    let isPopupOn = false\r\n    // TODO: see how to change this variable (check if reverse flow prop assignment works, otherwise use getContext and setContext)\r\n    let popupProps = {}\r\n    \r\n    let options = DEFAULT_OPTIONS\r\n    // load options\r\n    chrome.storage.sync.get('options').then(result => {\r\n        options = result.options || DEFAULT_OPTIONS\r\n    })\r\n    \r\n    let hoverContent = []\r\n\r\n    onMount(() => {\r\n        // --- run on domready\r\n        if (parentDocument.readyState === 'complete') {\r\n            readyParent()\r\n        } else {\r\n            parentDocument.addEventListener(\"DOMContentLoaded\", readyParent())\r\n        }\r\n    })\r\n    \r\n    function hoverAnimateLoop() {\r\n        // if (isExtensionOn) {\r\n            hoverNode.style.left = hoverX + 'px'\r\n            hoverNode.style.top = hoverY + 'px'\r\n            window.requestAnimationFrame(hoverAnimateLoop)\r\n        // }\r\n    }\r\n    \r\n    function readyParent() {\r\n        // we'll assume this is always constant cuz it probably is + saves on performance\r\n        pageWidth = Util.getPageWidth()\r\n    \r\n        // check if extension is globally enabled \r\n        chrome.runtime.sendMessage({type: 'isExtensionOn'}, response => {\r\n            console.log('checking: isExtensionOn?',response.isExtensionOn)\r\n            // check if isExtensionOn is already on so we don't run this function twice\r\n            if (response.isExtensionOn && !isExtensionOn) {\r\n                enableExtension() \r\n            }\r\n        })\r\n    \r\n        setTimeout(() => { // wait a bit for 1st trigger of onmousemove so that we have mouseX and mouseY being non-0.\r\n            hoverAnimateLoop()\r\n        }, 50)\r\n    }\r\n    \r\n    // LISTEN TO MESSAGES FROM BACKGROUND SCRIPT\r\n    chrome.runtime.onMessage.addListener(\r\n        function(request, sender, sendResponse) {\r\n            console.log('receiving request:', request.type)\r\n            switch (request.type) {\r\n                case 'enableExtension':\r\n                    if (!isExtensionOn) enableExtension()\r\n                    break\r\n                case 'disableExtension':\r\n                    disableExtension()\r\n                    break\r\n                case 'updateOptions':\r\n                    options = request.data\r\n                    break\r\n                default:\r\n                    break\r\n            }\r\n        }\r\n    )\r\n    \r\n    // ENABLE/DISABLE EXTENSION\r\n    function enableExtension() {\t\r\n        isExtensionOn = true\r\n        parentDocument.addEventListener('mousemove', handleMouseMove)\r\n        parentDocument.addEventListener('selectionchange', handleSelectionChange)\r\n        \r\n        parentDocument.body.appendChild(rootNode)\r\n    }   \r\n    \r\n    function disableExtension() {\r\n        isExtensionOn = false\r\n        parentDocument.removeEventListener('mousemove', handleMouseMove)\r\n        parentDocument.removeEventListener('selectionchange', handleSelectionChange)\r\n    \r\n        let existingShadowRoot = parentDocument.getElementById(`${EXTENSION_ALIAS}-root`)\r\n        if (existingShadowRoot) {\r\n            existingShadowRoot.remove()\r\n        }\r\n    }\r\n    \r\n    // SHOW/HIDE HOVER \r\n    function showHover(data) {\r\n        hoverContent = data\r\n        isHoverOn = true\r\n        hoverNode.style.opacity = 1\r\n    }\r\n    \r\n    function hideHover() {\r\n        if (isMakingSelection) return\r\n        isHoverOn = false\r\n        // hoverContent = []\r\n        previousWord = ''\r\n        hoverNode.style.opacity = 0\r\n    }\r\n    \r\n    function handleSelectionChange(e) {    \r\n        // https://stackoverflow.com/a/5379408\r\n        // https://stackoverflow.com/a/52157976 - this one would be cool because this listener will update on EVERY CHARACTER SELECTED instead of just mouseup. so maybe we could animate the hover with that.\r\n    \r\n        // https://stackoverflow.com/a/17569535 MODIFIED\r\n        // get selection \r\n        let selection = parentDocument.getSelection()\r\n        if (!selection.isCollapsed) {\r\n            let selectionRange = selection.getRangeAt(0)\r\n            let selectionText = selection.getRangeAt(0).toString().trim()\r\n            let selectionRect = selectionRange.getBoundingClientRect()\r\n    \r\n            isMakingSelection = true\r\n        \r\n            hoverX = selectionRect.x + (selectionRect.width / 2) - (hoverNode.offsetWidth / 2)\r\n            // https://stackoverflow.com/a/7436602\r\n            // hoverY = selectionRect.y + parentDocument.documentElement.scrollTop - hoverNode.offsetHeight - (options.distanceToMouse.value * options.UIScale.value)\r\n            // TODO: fix hover hiding atop of page if it's too high up\r\n            hoverY = selectionRect.y + parentDocument.documentElement.scrollTop - ((hoverNode.offsetHeight + options.distanceToMouse.value) * options.UIScale.value)\r\n    \r\n            showHover([{\r\n                isSvelteComponent: true,\r\n                component: ToolBar,\r\n                props: {    \r\n                    staticHoverNode, \r\n                    parentDocument, \r\n                    selectionText,\r\n                    hideToolbar: () => {isMakingSelection=false;hideHover()},\r\n                    options\r\n                },\r\n            }])\r\n    \r\n        } else {\r\n            isMakingSelection = false\r\n            hideHover()\r\n        }\r\n    }\r\n    \r\n    \r\n    function handleMouseMove(e) {\r\n        cursorX = e.pageX\r\n        cursorY = e.pageY\r\n    \r\n        if (!hoverNode) return\r\n        if (isMakingSelection) return\r\n    \r\n        const range = parentDocument.caretRangeFromPoint(e.clientX, e.clientY)\r\n        if (!range) return\r\n        const node = range.startContainer\r\n        const nodeContent = node.nodeValue\r\n        if (!nodeContent) { // actually looking for (nodeContent !== null) but this is more general\r\n            hideHover()\r\n        } else {\r\n            // get position of cursor in a block of text\r\n            const cursorOffset = range.startOffset;\r\n        \r\n            const textLeftOfCursor = nodeContent.slice(0, cursorOffset)\r\n            const textRightOfCursor = nodeContent.slice(cursorOffset)\r\n            if (textLeftOfCursor && textRightOfCursor) { // mouse is over text\r\n                // regex honorable mentions:\r\n                // [^\\p{L}\\p{M}] - match any non \"readable\" character (l is charcter, m is accent)\r\n                // pattern(?![\\s\\S]*pattern) - negative lookahead / find last occurance -- https://stackoverflow.com/a/41870151\r\n                // NEW NEW pattern: [A-Za-zÀ-ÖØ-öø-ÿ9-] (and then negate it)\r\n                \r\n                // by separator we mean anything that would separate a word, like comma or space\r\n                const leftSeparatorIndex = textLeftOfCursor.search(/[^\\p{L}\\p{M}0-9-](?![\\s\\S]*[^\\p{L}\\p{M}0-9-])/u)\r\n                const rightSeparatorIndex = textRightOfCursor.search(/[^\\p{L}\\p{M}0-9-]/u)\r\n            \r\n                const startWordIndex = leftSeparatorIndex === -1 ? 0 : leftSeparatorIndex + 1 // ...? fallback : actual index \r\n                const endWordIndex = rightSeparatorIndex === -1 ? nodeContent.length : cursorOffset + rightSeparatorIndex\r\n    \r\n                // cut the desired word off of the text block\r\n                const word = nodeContent.slice(startWordIndex, endWordIndex)\r\n                // sanitize\r\n                const cleanedWord = word\r\n                .toLowerCase()\r\n                // .replace(/[^\\p{L}]/ug, \"\")\r\n    \r\n                // https://stackoverflow.com/a/10805180\r\n                // we only need to update it if it's actually different from the previous word\r\n                if (cleanedWord !== previousWord) {\r\n                    if (!cleanedWord) return\r\n                    previousWord = cleanedWord  \r\n                    chrome.runtime.sendMessage({word: cleanedWord, type: 'getGender'}, (response) => {\r\n                        // console.log('response',response)\r\n                        if (response.data.length > 0) { \r\n                            showHover(response.data)\r\n                        } else {\r\n                            hideHover()\r\n                        }\r\n                    })\r\n                }\r\n            }\r\n        }\r\n    \r\n        // update render\r\n        updateHoverCoordinates(e)\r\n    }\r\n    \r\n    function updateHoverCoordinates(e) {\r\n        if (!isMakingSelection) {\r\n            // we don't want it going out of the window so we set a max horizontal distance it can go\r\n            hoverX = Math.min(window.innerWidth - (hoverNode.offsetWidth * options.UIScale.value) - 10, e.pageX + (options.distanceToMouse.value * options.UIScale.value))\r\n            // same concept for vertical distance, we just don't want it crossing <0 (also giving it an offest of 10 so it doesn't glue to the edge)\r\n            hoverY = Math.max(e.pageY - hoverNode.offsetHeight - (options.distanceToMouse.value * options.UIScale.value), 10)\r\n        }\r\n    }\r\n    \r\n</script>\r\n    \r\n<div id=\"hover\" class=\"select-none absolute truncate text-white rounded z-[999]\" bind:this={hoverNode} style=\"--UIScale: {options.UIScale.value}; pointer-events: {isMakingSelection ? 'all' : 'none'}\">\r\n    <div id=\"hover-content\" class=\"\" bind:this={hoverContentNode}>\r\n        {#each hoverContent as entry}\r\n            {#if entry.isSvelteComponent}\r\n                <svelte:component this={entry.component} {...entry.props}/>\r\n            {:else}\r\n                <div class=\"blurry-bg {entry.gender}-entry flex pointer-events-none px-1 w-full items-center text-center text-sm font-bold\">\r\n                    <img src=\"{entry.flagURL}\"class=\"block mr-1 rounded-[3px]\" alt=\"{entry.countryCode} flag\"/>\r\n                    <div class=\"opacity-90\">{entry.wordForGender}</div>\r\n                </div>\r\n            {/if}\r\n        {/each} \r\n    </div>\r\n</div>\r\n<div bind:this={staticHoverNode} id=\"static-hover\" class=\"absolute left-0 top-0\">\r\n</div>\r\n\r\n<style lang=\"postcss\">\r\n    @tailwind base;\r\n    @tailwind components;\r\n    @tailwind utilities;\r\n    \r\n    :global(.m-entry) {\r\n        background: linear-gradient(to right, hsla(223, 92%, 54%, .8), hsla(203, 92%, 54%, .5));\r\n    }   \r\n\r\n    :global(.f-entry) {\r\n        background: linear-gradient(to right, hsla(306, 92%, 54%, .8), hsla(284, 92%, 54%, .5));\r\n    }\r\n\r\n    :global(.n-entry) {\r\n        background: linear-gradient(to right, hsla(137, 92%, 54%, .8), hsla(117, 92%, 54%, .5));\r\n    }\r\n\r\n    #hover {\r\n        transform-origin: bottom left;\r\n        scale: var(--UIScale);\r\n        \r\n        transition: top .15s, left .15s, opacity .15s ease-in-out;\r\n        transition-timing-function: cubic-bezier(.42,.29,0,1.28);\r\n    }\r\n        \r\n    .blurry-bg {\r\n        -webkit-backdrop-filter: blur(3px); \r\n        backdrop-filter: blur(3px);\r\n    }\r\n\r\n</style>\r\n    "],"names":["ctx","create_if_block_3","if_block1","create_if_block_2","i","insert","target","div17","anchor","append","div9","div16","h1","form","div14","div11","label0","div10","select0","select1","div13","label1","div12","select2","select3","div15","button","TRANSITION_DURATION_MS","create_if_block_5","create_if_block_6","create_if_block_7","create_if_block_8","create_if_block_4","attr","div1","div1_class_value","div0","current","dirty","div1_transition","create_bidirectional_transition","horizontalSlideDisconsiderBorder","a","div","add_render_callback","span2","span0","span1","option","set_data","t","t_value","if_block","create_if_block_1","div1_input_handler","div2_input_handler","label","small","div3","div2","t0","t0_value","create_if_block","dialog","syncDeckAndModelChoices","deckName","modelName","syncFields","fieldsData","obj","fieldName","staticHoverNode","$$props","parentDocument","options","contentToSave","initialX","initialY","popupNode","isPopupBeingDragged","isPopupEnabled","cardModelSelectNode","selectedDeck","deckNameSelectNode","selectedModel","savedSyncFields","cardDecks","cardModels","cardModelFieldsData","messageType","canSubmit","highlightWarnClose","highlightSubmitSuccessful","onMount","$$invalidate","tryAnkiConnectionLoop","handleDocumentMouseUp","isFirstTime","newCardDecks","getDeckNames","newCardModels","getModelNames","updateModelFields","AnkiResponseError","err","handleAnkiError","secsUntilRetry","error","callback","AnkiConnectionError","countdown","handleSubmit","e","formData","fieldsDataReplaced","callbackResult","addNote","initialDragOffsetX","initialDragOffsetY","handleDragMouseDown","popupRect","handleDragMouseMove","handleDragMouseUp","EXTENSION_ALIAS","removePopup","handleDeckSelectionChange","handleModelSelectChange","fields","getModelFieldNames","compareArrays","field","savedFieldContent","replaceWithCoolSpan","content","escapedContent","escapeHtml","idxOfReplaceable","REPLACEMENT_STRING","newContent","handleFieldInput","$$value","img","img_src_value","selectionText","hideToolbar","toolbarNode","spawnPopup","toolbarRect","Popup","handleClickAnki","t1_value","src_url_equal","img_alt_value","t1","switch_instance_spread_levels","switch_value","get_spread_update","get_spread_object","each_blocks","rootNode","shadowRootNode","isExtensionOn","hoverNode","hoverContentNode","hoverX","hoverY","isMakingSelection","previousWord","DEFAULT_OPTIONS","result","hoverContent","readyParent","hoverAnimateLoop","Util.getPageWidth","response","enableExtension","request","sender","sendResponse","disableExtension","handleMouseMove","handleSelectionChange","existingShadowRoot","showHover","data","hideHover","selection","selectionRange","selectionRect","ToolBar","range","nodeContent","cursorOffset","textLeftOfCursor","textRightOfCursor","leftSeparatorIndex","rightSeparatorIndex","startWordIndex","endWordIndex","cleanedWord","updateHoverCoordinates"],"mappings":"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"}