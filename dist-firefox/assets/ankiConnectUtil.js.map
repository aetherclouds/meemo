{"version":3,"file":"ankiConnectUtil.js","sources":["../../src/js/ankiConnectUtil.js"],"sourcesContent":["export class AnkiConnectionError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = \"AnkiConnectionError\";\r\n  }\r\n}\r\n\r\nexport class AnkiResponseError extends Error {\r\n  constructor(message) {\r\n    super(message);\r\n    this.name = \"AnkiResponseError\";\r\n  }\r\n}\r\n\r\nexport async function ankiRequestThroughBg(action, params={}) {\r\n  const response = (await chrome.runtime.sendMessage({type: 'runAnkiRequest', data: {action, params}})).response\r\n  // console.log('receiving anki response:', response)\r\n  if (response.error) {\r\n    // console.error(response.error)\r\n    switch (response.error) {\r\n      case 'AnkiConnectionError':\r\n        throw new AnkiConnectionError()\r\n      case 'AnkiResponseError':\r\n        throw new AnkiResponseError()\r\n      default:\r\n        throw new Error(response.error.name)\r\n    }\r\n  } else {\r\n    return response.response\r\n  }\r\n}\r\n\r\nexport async function ankiRequest(action, params={}, version=6) {\r\n  const data = {action, version, params}\r\n  return fetch('http://127.0.0.1:8765', {\r\n    method: \"POST\",\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify(data)\r\n  }).then(async promisedResponse => { \r\n    if (!promisedResponse.ok) {\r\n      throw new AnkiResponseError()\r\n    } else {\r\n      const response = await promisedResponse.json()\r\n      // console.log('unprocessed response:',response)\r\n      if (response.result === null) {\r\n        throw new AnkiResponseError(response.error)\r\n      }\r\n      return {response: response.result, error: null}\r\n    }\r\n  }\r\n  ).catch(err => {\r\n    if (!(err instanceof AnkiResponseError)) {\r\n      err = new AnkiConnectionError(err.response)\r\n    }\r\n    return {response: null, error: err.name}\r\n  })\r\n}\r\n\r\n// here's what we gotta do:\r\n// 1: get models\r\n// 2: get decks\r\n// - display models & decks for selection\r\n// 3: add note\r\n\r\nexport async function getModelNames() {\r\n  return ankiRequestThroughBg('modelNames')\r\n}\r\nexport async function getDeckNames() {\r\n  return ankiRequestThroughBg('deckNames')\r\n}\r\n\r\nexport async function getModelFieldNames(modelName) {\r\n  return ankiRequestThroughBg('modelFieldNames', {'modelName': modelName})\r\n}\r\n\r\nexport async function addNote(deckName, modelName, fields) {\r\n  return ankiRequestThroughBg('addNote', {\r\n    'note': {\r\n      'deckName': deckName,\r\n      'modelName': modelName,\r\n      'fields': fields,\r\n      'tags': ['fromMeemo!'],\r\n      \"options\": {\r\n        \"allowDuplicate\": true,\r\n    },\r\n    }\r\n  })\r\n}\r\n\r\nexport async function test() {\r\n  const response = await ankiRequestThroughBg('modelNames',)\r\n  console.log(await getDeckNames())\r\n    console.log(response)\r\n}"],"names":["AnkiConnectionError","message","AnkiResponseError","ankiRequestThroughBg","action","params","response","ankiRequest","version","promisedResponse","err","getModelNames","getDeckNames","getModelFieldNames","modelName","addNote","deckName","fields"],"mappings":"AAAO,MAAMA,UAA4B,KAAM,CAC7C,YAAYC,EAAS,CACnB,MAAMA,CAAO,EACb,KAAK,KAAO,qBACb,CACH,CAEO,MAAMC,UAA0B,KAAM,CAC3C,YAAYD,EAAS,CACnB,MAAMA,CAAO,EACb,KAAK,KAAO,mBACb,CACH,CAEO,eAAeE,EAAqBC,EAAQC,EAAO,GAAI,CAC5D,MAAMC,GAAY,MAAM,OAAO,QAAQ,YAAY,CAAC,KAAM,iBAAkB,KAAM,CAAC,OAAAF,EAAQ,OAAAC,CAAM,CAAC,CAAC,GAAG,SAEtG,GAAIC,EAAS,MAEX,OAAQA,EAAS,MAAK,CACpB,IAAK,sBACH,MAAM,IAAIN,EACZ,IAAK,oBACH,MAAM,IAAIE,EACZ,QACE,MAAM,IAAI,MAAMI,EAAS,MAAM,IAAI,CACtC,KAED,QAAOA,EAAS,QAEpB,CAEO,eAAeC,EAAYH,EAAQC,EAAO,CAAA,EAAIG,EAAQ,EAAG,CAE9D,OAAO,MAAM,wBAAyB,CACpC,OAAQ,OACR,QAAS,CACP,eAAgB,kBACjB,EACD,KAAM,KAAK,UANA,CAAC,OAAAJ,EAAQ,QAAAI,EAAS,OAAAH,CAAM,CAMV,CAC7B,CAAG,EAAE,KAAK,MAAMI,GAAoB,CAChC,GAAKA,EAAiB,GAEf,CACL,MAAMH,EAAW,MAAMG,EAAiB,KAAM,EAE9C,GAAIH,EAAS,SAAW,KACtB,MAAM,IAAIJ,EAAkBI,EAAS,KAAK,EAE5C,MAAO,CAAC,SAAUA,EAAS,OAAQ,MAAO,IAAI,MAP9C,OAAM,IAAIJ,CASb,CACH,EAAI,MAAMQ,IACAA,aAAeR,IACnBQ,EAAM,IAAIV,EAAoBU,EAAI,QAAQ,GAErC,CAAC,SAAU,KAAM,MAAOA,EAAI,IAAI,EACxC,CACH,CAQO,eAAeC,GAAgB,CACpC,OAAOR,EAAqB,YAAY,CAC1C,CACO,eAAeS,GAAe,CACnC,OAAOT,EAAqB,WAAW,CACzC,CAEO,eAAeU,EAAmBC,EAAW,CAClD,OAAOX,EAAqB,kBAAmB,CAAC,UAAaW,CAAS,CAAC,CACzE,CAEO,eAAeC,EAAQC,EAAUF,EAAWG,EAAQ,CACzD,OAAOd,EAAqB,UAAW,CACrC,KAAQ,CACN,SAAYa,EACZ,UAAaF,EACb,OAAUG,EACV,KAAQ,CAAC,YAAY,EACrB,QAAW,CACT,eAAkB,EACrB,CACA,CACL,CAAG,CACH"}